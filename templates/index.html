<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="OTSU Watermark Tool - Add professional watermarks to your images and videos instantly.">
    <title>OTSU Watermark Tool</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="stylesheet" href="/static/css/style.css?v=2">
</head>

<body>

    <div class="container">

        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="/static/logo/Otsu_Logo_white.png" alt="OTSU LABS">
            </div>
            <h1>Watermark Tool</h1>
            <p>Upload ảnh hoặc video, hệ thống sẽ tự động gán watermark "OTSU LABS" vào chính giữa nội dung của bạn.</p>
        </header>

        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" class="file-input" accept="image/*,video/*">
            <div class="upload-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
            </div>
            <h3>Kéo thả file vào đây hoặc <span>chọn file</span></h3>
            <p>Hỗ trợ hình ảnh và video</p>
            <div class="formats">
                <span class="format-badge">JPG</span>
                <span class="format-badge">PNG</span>
                <span class="format-badge">WEBP</span>
                <span class="format-badge">MP4</span>
                <span class="format-badge">MOV</span>
                <span class="format-badge">AVI</span>
            </div>
            <p class="limit-note">Giới hạn upload: < 500MB</p>
        </div>

        <!-- Processing Progress -->
        <div class="progress-section" id="progressSection">
            <div class="progress-card">
                <div class="progress-file-info">
                    <div class="progress-file-icon" id="progressFileIcon">
                        <svg viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <polyline points="21 15 16 10 5 21" />
                        </svg>
                    </div>
                    <div>
                        <div class="progress-file-name" id="progressFileName">filename.jpg</div>
                        <div class="progress-file-size" id="progressFileSize">2.4 MB</div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-status">
                    <span class="status-text">
                        <span class="spinner"></span>
                        <span id="statusText">Đang xử lý...</span>
                    </span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
        </div>

        <!-- Result Section -->
        <div class="result-section" id="resultSection">
            <div class="result-card">
                <div class="result-header">
                    <div class="result-check">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                    </div>
                    <h3>Gán watermark thành công!</h3>
                </div>
                <div class="preview-container" id="previewContainer"></div>
                <a class="download-btn" id="downloadBtn" href="#">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Tải xuống
                </a>
                <button class="another-btn" id="anotherBtn">
                    + Xử lý file khác
                </button>
            </div>
        </div>

        <!-- Error Section -->
        <div class="error-section" id="errorSection">
            <div class="error-card">
                <div class="error-icon">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="15" y1="9" x2="9" y2="15" />
                        <line x1="9" y1="9" x2="15" y2="15" />
                    </svg>
                </div>
                <div class="error-text" id="errorText">Đã xảy ra lỗi khi xử lý file.</div>
            </div>
            <button class="another-btn" id="retryBtn" style="margin-top: 12px;">
                Thử lại
            </button>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Powered by <a href="https://github.com/hunkmik3/watermark" target="_blank">OTSU LABS Watermark</a></p>
        </footer>

    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        const errorSection = document.getElementById('errorSection');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressFileName = document.getElementById('progressFileName');
        const progressFileSize = document.getElementById('progressFileSize');
        const progressFileIcon = document.getElementById('progressFileIcon');
        const statusText = document.getElementById('statusText');
        const previewContainer = document.getElementById('previewContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const anotherBtn = document.getElementById('anotherBtn');
        const retryBtn = document.getElementById('retryBtn');
        const errorText = document.getElementById('errorText');

        // Click to upload
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) handleFile(fileInput.files[0]);
        });

        // Reset
        anotherBtn.addEventListener('click', resetUI);
        retryBtn.addEventListener('click', resetUI);

        function resetUI() {
            uploadArea.style.display = '';
            progressSection.classList.remove('active');
            resultSection.classList.remove('active');
            errorSection.classList.remove('active');
            fileInput.value = '';
            progressBar.style.width = '0%';
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function isVideo(filename) {
            return /\.(mp4|mov|avi|mkv|webm)$/i.test(filename);
        }

        function handleFile(file) {
            // Show progress
            uploadArea.style.display = 'none';
            resultSection.classList.remove('active');
            errorSection.classList.remove('active');
            progressSection.classList.add('active');

            progressFileName.textContent = file.name;
            progressFileSize.textContent = formatSize(file.size);
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';

            // Update icon based on type
            const isVid = isVideo(file.name);
            progressFileIcon.innerHTML = isVid
                ? '<svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>'
                : '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';

            if (isVid) {
                statusText.textContent = 'Đang gán watermark vào video (có thể mất vài phút)...';
            } else {
                statusText.textContent = 'Đang gán watermark...';
            }

            // Fake progress animation
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += isVid ? 0.5 : 2;
                    progressBar.style.width = progress + '%';
                    progressPercent.textContent = Math.round(progress) + '%';
                }
            }, isVid ? 500 : 100);

            // Upload
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    clearInterval(progressInterval);

                    if (data.error) {
                        showError(data.error);
                        return;
                    }

                    // Complete progress
                    progressBar.style.width = '100%';
                    progressPercent.textContent = '100%';
                    statusText.textContent = 'Hoàn tất!';

                    setTimeout(() => {
                        progressSection.classList.remove('active');
                        showResult(data);
                    }, 600);
                })
                .catch(err => {
                    clearInterval(progressInterval);
                    showError('Không thể kết nối tới server. Vui lòng thử lại.');
                });
        }

        function showResult(data) {
            resultSection.classList.add('active');

            const previewUrl = `/preview/${data.filename}`;
            const downloadUrl = `/download/${data.filename}?original_name=${encodeURIComponent(data.original_name)}`;
            downloadBtn.href = downloadUrl;
            downloadBtn.download = `watermarked_${data.original_name}`;

            // Preview
            previewContainer.innerHTML = '';
            if (data.type === 'image') {
                const img = document.createElement('img');
                img.src = previewUrl;
                img.alt = 'Watermarked preview';
                previewContainer.appendChild(img);
            } else {
                const video = document.createElement('video');
                video.src = previewUrl;
                video.controls = true;
                video.autoplay = true;
                video.muted = true;
                previewContainer.appendChild(video);
            }
        }

        function showError(message) {
            progressSection.classList.remove('active');
            errorSection.classList.add('active');
            errorText.textContent = message;
        }
    </script>

</body>

</html>